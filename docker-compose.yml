version: '3.8'

services:
  # Splunk Enterprise - Main SIEM
  splunk:
    image: splunk/splunk:latest
    container_name: splunk-enterprise
    platform: linux/amd64
    environment:
      - SPLUNK_START_ARGS=--accept-license
      - SPLUNK_PASSWORD=ChangeMe123!
      - SPLUNK_HEC_TOKEN=abcd1234-5678-90ab-cdef-1234567890ab
      - SPLUNK_GENERAL_TERMS=--accept-sgt-current-at-splunk-com
    ports:
      - "8000:8000"  # Web UI
      - "8088:8088"  # HEC (HTTP Event Collector)
      - "9997:9997"  # Splunk forwarder
      - "514:514/udp"  # Syslog
    volumes:
      - splunk-data:/opt/splunk/var
      - splunk-etc:/opt/splunk/etc
      - ./splunk-apps:/opt/splunk/etc/apps
    networks:
      - soc-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Nginx Web Server - Generates web access logs
  webserver:
    image: nginx:latest
    container_name: web-server
    ports:
      - "8080:80"
    volumes:
      - ./logs/nginx:/var/log/nginx
      - ./configs/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - soc-network
    depends_on:
      - splunk

  # Universal Forwarder for Nginx
  splunk-forwarder-web:
    image: splunk/universalforwarder:latest
    container_name: splunk-uf-web
    user: root
    platform: linux/amd64
    environment:
      - SPLUNK_START_ARGS=--accept-license
      - SPLUNK_GENERAL_TERMS=--accept-sgt-current-at-splunk-com
      - SPLUNK_PASSWORD=ChangeMe123!
      - SPLUNK_FORWARD_SERVER=splunk:9997
    volumes:
      - ./logs/nginx:/logs/nginx:ro
    networks:
      - soc-network
    depends_on:
      - splunk

  # MySQL Database - Generates database logs
  mysql:
    image: mysql:8.0
    container_name: mysql-db
    platform: linux/amd64
    environment:
      - MYSQL_ROOT_PASSWORD=RootPass123!
      - MYSQL_DATABASE=production_db
      - MYSQL_USER=appuser
      - MYSQL_PASSWORD=AppPass123!
    volumes:
      - mysql-data:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
      - ./configs/mysql.cnf:/etc/mysql/conf.d/custom.cnf
    networks:
      - soc-network
    command: --general-log=1 --general-log-file=/var/log/mysql/general.log --log-error=/var/log/mysql/error.log

  # Universal Forwarder for MySQL
  splunk-forwarder-db:
    image: splunk/universalforwarder:latest
    container_name: splunk-uf-db
    user: root
    platform: linux/amd64
    environment:
      - SPLUNK_START_ARGS=--accept-license
      - SPLUNK_GENERAL_TERMS=--accept-sgt-current-at-splunk-com
      - SPLUNK_PASSWORD=ChangeMe123!
      - SPLUNK_FORWARD_SERVER=splunk:9997
    volumes:
      - ./logs/mysql:/logs/mysql:ro
    networks:
      - soc-network
    depends_on:
      - splunk
      - mysql

  # Syslog-ng - Centralized syslog server
  syslog:
    image: balabit/syslog-ng:latest
    container_name: syslog-server
    ports:
      - "5514:514/udp"
      - "5514:514/tcp"
    volumes:
      - ./logs/syslog:/var/log/syslog
      - ./configs/syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf
    networks:
      - soc-network

  # Kali Linux - Attack simulation
  kali:
    image: kalilinux/kali-rolling
    container_name: kali-attacker
    platform: linux/amd64
    stdin_open: true
    tty: true
    volumes:
      - ./attack-scripts:/root/scripts
    networks:
      - soc-network
    command: /bin/bash

  # Ubuntu Target - Vulnerable target system
  ubuntu-target:
    image: ubuntu:22.04
    container_name: ubuntu-target
    stdin_open: true
    tty: true
    volumes:
      - ./logs/ubuntu:/var/log
    networks:
      - soc-network
    command: |
      /bin/bash -c "
      apt-get update && 
      apt-get install -y openssh-server apache2 rsyslog curl &&
      service ssh start &&
      service apache2 start &&
      service rsyslog start &&
      tail -f /dev/null
      "

  # Log Generator - Simulates various log events
  log-generator:
    image: mingrammer/flog
    container_name: log-generator
    volumes:
      - ./logs/generated:/var/log/generated
    networks:
      - soc-network
    command: -f apache_combined -o /var/log/generated/access.log -d 2 -l

volumes:
  splunk-data:
  splunk-etc:
  mysql-data:

networks:
  soc-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
